<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Box Collector - Debug Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #renderCanvas { width: 100%; height: 100%; }
        
        /* Debug Panel */
        #debugPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
        }
        
        #debugLog {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        .debug-entry {
            margin: 2px 0;
            padding: 2px;
            border-bottom: 1px solid #333;
        }
        
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #44ff44; }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <!-- Debug Panel -->
    <div id="debugPanel">
        <h3 style="margin:0; color:white;">üîß Debug Console</h3>
        <div>
            <button onclick="clearDebug()">Clear</button>
            <button onclick="toggleDebug()">Hide</button>
            <button onclick="testVR()">Test VR</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <!-- Your existing UI -->
    <div id="ui" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; z-index: 1000;">
        <h2>üéØ Box Collector - DEBUG</h2>
        <div>Boxes: <span id="score">0</span>/10 | Time: <span id="timer">60</span>s</div>
        <div>VR Mode: <span id="vrStatus">No</span></div>
        <div>Game Active: <span id="gameStatus">No</span></div>
    </div>

    <div id="gameUI" style="position: absolute; bottom: 20px; width: 100%; text-align: center;">
        <button onclick="startGame()">üöÄ Start Game</button>
        <button onclick="enterVR()">üï∂Ô∏è VR Mode</button>
    </div>

    <script>
        // ==================== DEBUG FUNCTIONS ====================
        let debugEnabled = true;
        
        function debugLog(message, type = 'info') {
            if (!debugEnabled) return;
            
            const debugLog = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = debug-entry ${type};
            entry.innerHTML = [${new Date().toLocaleTimeString()}] ${message};
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log([DEBUG] ${message});
        }
        
        function clearDebug() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function testVR() {
            debugLog('Testing VR support...', 'info');
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-vr')
                    .then(supported => {
                        debugLog(VR supported: ${supported}, supported ? 'info' : 'warning');
                    })
                    .catch(err => {
                        debugLog(VR test error: ${err.message}, 'error');
                    });
            } else {
                debugLog('WebXR not available', 'error');
            }
        }
        
        // ==================== GAME CODE ====================
        // Game variables
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let gameTimer;
        let boxes = [];
        let reticle;
        let vrMode = false;
        let xrExperience = null;
        let currentTargetedBox = null;
        let gazeTimer = null;

        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine);
        
        // Enable scene debug layer
        scene.debugLayer.show().catch(err => {
            debugLog('Debug layer failed: ' + err.message, 'warning');
        });
        
        // Create camera
        const camera = new BABYLON.UniversalCamera('camera', new BABYLON.Vector3(0, 1.6, 0), scene);
        camera.attachControl(canvas, true);
        
        // Create lighting
        const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
        light.intensity = 0.8;

        debugLog('Babylon.js scene initialized', 'info');

        // [REST OF YOUR GAME CODE GOES HERE - copy all the functions from previous version]
        // createEnvironment(), createVRReticle(), createBoxes(), etc.
        
        // Modified startGame with debug info
        function startGame() {
            if (gameActive) return;
            
            debugLog('Starting game...', 'info');
            
            // Reset game state
            score = 0;
            timeLeft = 60;
            gameActive = true;
            
            document.getElementById('score').textContent = score;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('gameStatus').textContent = 'Yes';
            document.getElementById('gameUI').style.display = 'none';
            
            try {
                // Create game elements
                createEnvironment();
                if (vrMode) {
                    createVRReticle();
                } else {
                    createRegularReticle();
                }
                createBoxes(15);
                
                debugLog('Game environment created', 'info');
                
                // Start timer
                gameTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endGame(false);
                    }
                }, 1000);

                // Start game loop
                scene.onBeforeRenderObservable.add(gameLoop);
                debugLog('Game loop started', 'info');
                
            } catch (error) {
                debugLog('Game start error: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Modified enterVR with debug info
        async function enterVR() {
            if (vrMode) return;
            
            debugLog('Entering VR mode...', 'info');
            
            try {
                if (boxes.length === 0) {
                    createEnvironment();
                    createBoxes(15);
                }
                
                createVRReticle();
                
                xrExperience = await scene.createDefaultXRExperienceAsync({
                    uiOptions: {
                        sessionMode: 'immersive-vr'
                    }
                });
                
                vrMode = true;
                document.getElementById('vrStatus').textContent = 'Yes';
                document.getElementById('gameUI').innerHTML = '<div style="color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;">VR Mode Active! Look at boxes to collect them</div>';
                
                debugLog('VR experience created successfully', 'info');
                
                // Set up VR event debugging
                xrExperience.baseExperience.sessionManager.onXRSessionInit.add(() => {
                    debugLog('XR Session initialized', 'info');
                });
                
                xrExperience.baseExperience.sessionManager.onXRSessionEnded.add(() => {
                    debugLog('XR Session ended', 'info');
                    vrMode = false;
                    document.getElementById('vrStatus').textContent = 'No';
                });
                
                if (xrExperience.baseExperience.input) {
                    xrExperience.baseExperience.input.onSelectObservable.add(() => {
                        debugLog('VR controller select event', 'info');
                    });
                }
                
            } catch (error) {
                debugLog('VR failed: ' + error.message, 'error');
                console.error('VR Error:', error);
            }
        }

        // Add error handling to game loop
        function gameLoop() {
            if (!gameActive) return;
            
            try {
                updateBoxAnimations();
                handleGazeCollection();
            } catch (error) {
                debugLog('Game loop error: ' + error.message, 'error');
                console.error('Game loop error:', error);
            }
        }

        // Render loop with error handling
        engine.runRenderLoop(() => {
            try {
                scene.render();
            } catch (error) {
                debugLog('Render error: ' + error.message, 'error');
                console.error('Render error:', error);
            }
        });
        
        window.addEventListener('resize', () => engine.resize());

        // Initial debug info
        debugLog('Game loaded successfully', 'info');
        debugLog('WebXR available: ' + !!navigator.xr, 'info');
        
        // Test WebXR support
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-vr')
                .then(supported => {
                    debugLog('VR support test: ' + supported, supported ? 'info' : 'warning');
                });
        }

        // [COPY ALL YOUR OTHER GAME FUNCTIONS HERE]
        // createEnvironment, createVRReticle, createRegularReticle, createBoxes, 
        // updateBoxAnimations, checkReticleHit, handleGazeCollection, collectBox, endGame

    </script>
</body>
</html>
